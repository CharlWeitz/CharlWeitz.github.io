<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Cube 10cm³</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #000; color: #fff; }
        #overlay {
            position: fixed; inset: 0; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #111; padding: 20px; text-align: center;
        }
        #btn-start {
            padding: 18px 36px; font-size: 18px; font-weight: bold;
            background: #28a745; color: white; border: none; border-radius: 12px;
        }
        #status-log {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            font-family: monospace; font-size: 11px; color: #00ff00;
            background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px;
            pointer-events: none; z-index: 200; max-height: 120px; overflow-y: auto;
        }
    </style>

    <!-- LOAD LIBRARIES AS STANDARD SCRIPTS (Better for local IP bypass) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r154/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-world-three.prod.js"></script>
</head>
<body>

    <div id="status-log">Checking System...</div>

    <div id="overlay">
        <h2>10cm³ Cube AR</h2>
        <p>Local IP: 10.0.0.128</p>
        <button id="btn-start">START AR</button>
    </div>

    <div id="container"></div>

    <script>
        // 1. GLOBAL ERROR CATCHER (Shows errors before they break the app)
        const logEl = document.getElementById('status-log');
        const log = (msg) => {
            logEl.innerHTML += `<div>> ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        };

        window.onerror = function(msg, url, line) {
            log("JS ERROR: " + msg + " (Line: " + line + ")");
            return false;
        };

        // 2. CHECK IF LIBRARIES LOADED
        window.addEventListener('load', () => {
            if (typeof THREE === 'undefined') {
                log("FATAL: Three.js failed to load from CDN.");
            } else if (typeof MINDAR === 'undefined') {
                log("FATAL: MindAR failed to load from CDN.");
            } else {
                log("All libraries loaded. Click Start.");
            }
        });

        // 3. APP LOGIC
        const side = 0.021544; // 10cm³ volume side length

        document.getElementById('btn-start').addEventListener('click', async () => {
            log("Attempting to start...");

            try {
                // Request Motion Sensors
                if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    log("Asking for Motion Permission...");
                    const res = await DeviceOrientationEvent.requestPermission();
                    if (res !== 'granted') throw new Error("Sensor permission denied.");
                }

                document.getElementById('overlay').style.display = 'none';

                log("Initializing MindAR...");
                const mindarThree = new window.MINDAR.WORLD.MindARThree({
                    container: document.body,
                });

                const {renderer, scene, camera} = mindarThree;

                // Lighting
                scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1));
                
                // Cube
                const geometry = new THREE.BoxGeometry(side, side, side);
                const material = new THREE.MeshStandardMaterial({ color: 0x007bff });

                // Tap Logic
                window.addEventListener('click', (e) => {
                    const hit = mindarThree.hitTest(e.clientX, e.clientY);
                    if (hit) {
                        log("Cube placed.");
                        const mesh = new THREE.Mesh(geometry, material);
                        mesh.matrixAutoUpdate = false;
                        mesh.matrix.fromArray(hit);
                        const lift = new THREE.Matrix4().makeTranslation(0, side/2, 0);
                        mesh.matrix.multiply(lift);
                        scene.add(mesh);
                    }
                });

                log("Starting Camera...");
                await mindarThree.start();
                log("AR Ready!");

                renderer.setAnimationLoop(() => {
                    renderer.render(scene, camera);
                });

            } catch (err) {
                log("APP ERROR: " + err.message);
                alert("Error: " + err.message);
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoAR Red Cube</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: white; z-index: 10000;
            display: none; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center; padding: 20px;
        }
        #overlay a { color: #00afff; font-weight: bold; text-decoration: none; border-bottom: 1px solid; }
        #info {
            position: absolute; top: 10px; width: 100%; text-align: center;
            color: white; pointer-events: none; text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h2>WebXR Not Supported</h2>
        <p>This app requires WebXR, which is not natively supported in iOS Safari.</p>
        <p>Please open this page in the <a href="https://apps.apple.com/us/app/webxr-viewer/id1295998056">Mozilla WebXR Viewer app</a> to continue.</p>
    </div>

    <div id="info">Waiting for GPS and AR Session...</div>

    <!-- Import Three.js and ARButton -->
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // 1. Browser Check (Safari on iOS)
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        if (isSafari && isIOS) {
            document.getElementById('overlay').style.display = 'flex';
        }

        // 2. Constants & Configuration
        const TARGET_COORDS = { lat: -33.7325, lon: 18.437222 }; // Melkbosstrand
        let userCoords = null;
        let compassHeading = 0;

        // 3. Three.js Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Add AR Button
        document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['local-floor'] }));

        // Add Lighting
        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        scene.add(light);

        // Create the Big Red Cube (2m x 2m x 2m)
        const geometry = new THREE.BoxGeometry(2, 2, 2);
        const material = new THREE.MeshPhongMaterial({ color: 0xff0000 });
        const cube = new THREE.Mesh(geometry, material);
        cube.visible = false; // Hide until GPS is calculated
        scene.add(cube);

        // 4. Geolocation & Math
        function getDistanceAndBearing(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radius of earth in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;

            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            const bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;

            return { distance, bearing };
        }

        function updateCubePosition() {
            if (!userCoords) return;

            const { distance, bearing } = getDistanceAndBearing(
                userCoords.latitude, userCoords.longitude,
                TARGET_COORDS.lat, TARGET_COORDS.lon
            );

            // Calculate local position
            // In Three.js AR, -Z is Forward, +X is Right.
            // We adjust for the compass heading so 'Forward' aligns with true North.
            const angleRad = (bearing - compassHeading) * Math.PI / 180;
            
            const x = distance * Math.sin(angleRad);
            const z = -distance * Math.cos(angleRad);

            cube.position.set(x, 0, z); // Place at ground level
            cube.visible = true;
            
            document.getElementById('info').innerHTML = `Cube is ${distance.toFixed(1)}m away at ${bearing.toFixed(1)}Â°`;
        }

        // 5. Sensors
        navigator.geolocation.watchPosition((pos) => {
            userCoords = pos.coords;
            updateCubePosition();
        }, (err) => console.error(err), { enableHighAccuracy: true });

        // Get compass heading (Chrome/Android)
        window.addEventListener('deviceorientationabsolute', (e) => {
            if (e.alpha !== null) compassHeading = 360 - e.alpha;
        });

        // 6. Animation Loop
        renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>